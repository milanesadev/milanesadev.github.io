<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recorrido 3D por Casa - Comandos de Voz</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      #container {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      #voiceControl {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 100;
        max-width: 320px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      #manualControls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 100;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      #positionInfo {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        z-index: 100;
        font-family: "Courier New", monospace;
      }

      #voiceButton {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 20px;
        margin: 10px 0;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      #voiceButton:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      #voiceButton.listening {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
        }
      }

      .control-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 15px;
      }

      .control-btn {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        transition: all 0.2s ease;
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
      }

      .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(33, 150, 243, 0.4);
      }

      .turn-btn {
        grid-column: span 3;
        padding: 12px;
        font-size: 16px;
        background: linear-gradient(45deg, #9c27b0, #7b1fa2);
        box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);
      }

      .turn-btn:hover {
        box-shadow: 0 6px 12px rgba(156, 39, 176, 0.4);
      }

      h3 {
        margin-top: 0;
        margin-bottom: 12px;
        color: #333;
        font-size: 18px;
        text-align: center;
      }

      #status {
        font-size: 14px;
        color: #666;
        min-height: 40px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .instructions {
        position: absolute;
        bottom: 30px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 10px;
        font-size: 13px;
        max-width: 220px;
        backdrop-filter: blur(5px);
      }

      .command-list {
        font-size: 12px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .command-list li {
        margin: 3px 0;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="voiceControl">
        <h3>üéôÔ∏è Control por Voz</h3>
        <p id="status">Haz clic en "Iniciar Escucha" para comenzar</p>
        <button id="voiceButton">üé§ Iniciar Escucha</button>
        <div class="command-list">
          <p><strong>Comandos disponibles:</strong></p>
          <ul>
            <li>"Avanzar" o "Adelante"</li>
            <li>"Retroceder" o "Atr√°s"</li>
            <li>"Izquierda"</li>
            <li>"Derecha"</li>
            <li>"Girar izquierda"</li>
            <li>"Girar derecha"</li>
          </ul>
        </div>
      </div>

      <div id="manualControls">
        <h3>üéÆ Controles Manuales</h3>
        <div class="control-grid">
          <div></div>
          <button class="control-btn" id="forwardBtn">‚Üë</button>
          <div></div>
          <button class="control-btn" id="leftBtn">‚Üê</button>
          <button class="control-btn" id="backwardBtn">‚Üì</button>
          <button class="control-btn" id="rightBtn">‚Üí</button>
          <button class="turn-btn" id="turnLeftBtn">‚Ü∂ Girar Izquierda</button>
          <button class="turn-btn" id="turnRightBtn">‚Ü∑ Girar Derecha</button>
        </div>
      </div>

      <div id="positionInfo">
        <h3>üìç Posici√≥n</h3>
        <p>X: <span id="posX">0.00</span></p>
        <p>Z: <span id="posZ">0.00</span></p>
        <p>Rot: <span id="rotY">0</span>¬∞</p>
      </div>

      <div class="instructions">
        <p><strong>Controles adicionales:</strong></p>
        <p>WASD para moverte</p>
        <p>Flechas para girar</p>
        <p>Q/E para rotar</p>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
      // Variables globales
      let scene, camera, renderer;
      let player, house;
      let position = { x: 0, y: 0, z: -2 };
      let rotation = { x: 0, y: 0, z: 0 };
      let moveSpeed = 0.8; // Aumentado para movimiento m√°s visible
      let turnSpeed = Math.PI / 8; // Aumentado para rotaci√≥n m√°s r√°pida
      let isListening = false;
      let recognition;

      // Inicializaci√≥n
      function init() {
        // Crear escena
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Cielo azul
        scene.fog = new THREE.Fog(0x87ceeb, 20, 100);

        // Crear c√°mara
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(position.x, 1.6, position.z);

        // Crear renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById("container").appendChild(renderer.domElement);

        // Agregar luces
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(15, 25, 15);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 50;
        directionalLight.shadow.camera.left = -20;
        directionalLight.shadow.camera.right = 20;
        directionalLight.shadow.camera.top = 20;
        directionalLight.shadow.camera.bottom = -20;
        scene.add(directionalLight);

        // Crear casa
        createHouse();

        // Crear jugador
        createPlayer();

        // Crear suelo exterior
        createGround();

        // Configurar controles
        setupControls();

        // Configurar reconocimiento de voz
        setupVoiceRecognition();

        // Event listeners
        window.addEventListener("resize", onWindowResize);
        document.addEventListener("keydown", onKeyDown);

        // Iniciar animaci√≥n
        animate();
      }

      function createHouse() {
        const houseGroup = new THREE.Group();

        // Materiales mejorados
        const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xf5f5f5 });
        const roofMaterial = new THREE.MeshLambertMaterial({ color: 0x8b4513 });
        const floorMaterial = new THREE.MeshLambertMaterial({
          color: 0xd2b48c,
        });
        const windowMaterial = new THREE.MeshLambertMaterial({
          color: 0x87ceeb,
          transparent: true,
          opacity: 0.7,
        });
        const doorMaterial = new THREE.MeshLambertMaterial({ color: 0x654321 });

        // Paredes con mejor definici√≥n
        const wall1 = new THREE.Mesh(
          new THREE.BoxGeometry(12, 6, 0.3),
          wallMaterial
        );
        wall1.position.set(0, 3, 0);
        wall1.castShadow = true;
        wall1.receiveShadow = true;
        houseGroup.add(wall1);

        const wall2 = new THREE.Mesh(
          new THREE.BoxGeometry(12, 6, 0.3),
          wallMaterial
        );
        wall2.position.set(0, 3, -12);
        wall2.castShadow = true;
        wall2.receiveShadow = true;
        houseGroup.add(wall2);

        const wall3 = new THREE.Mesh(
          new THREE.BoxGeometry(0.3, 6, 12),
          wallMaterial
        );
        wall3.position.set(6, 3, -6);
        wall3.castShadow = true;
        wall3.receiveShadow = true;
        houseGroup.add(wall3);

        const wall4 = new THREE.Mesh(
          new THREE.BoxGeometry(0.3, 6, 12),
          wallMaterial
        );
        wall4.position.set(-6, 3, -6);
        wall4.castShadow = true;
        wall4.receiveShadow = true;
        houseGroup.add(wall4);

        // Techo
        const roof = new THREE.Mesh(
          new THREE.BoxGeometry(12.5, 0.3, 12.5),
          roofMaterial
        );
        roof.position.set(0, 6.5, -6);
        roof.castShadow = true;
        roof.receiveShadow = true;
        houseGroup.add(roof);

        // Piso interior
        const floor = new THREE.Mesh(
          new THREE.BoxGeometry(12, 0.2, 12),
          floorMaterial
        );
        floor.position.set(0, 0, -6);
        floor.receiveShadow = true;
        houseGroup.add(floor);

        // Puerta
        const door = new THREE.Mesh(
          new THREE.BoxGeometry(2.5, 3, 0.2),
          doorMaterial
        );
        door.position.set(0, 1.5, -0.15);
        door.castShadow = true;
        door.receiveShadow = true;
        houseGroup.add(door);

        // Ventanas
        const window1 = new THREE.Mesh(
          new THREE.BoxGeometry(2, 2, 0.1),
          windowMaterial
        );
        window1.position.set(4, 4, -0.15);
        window1.castShadow = true;
        window1.receiveShadow = true;
        houseGroup.add(window1);

        const window2 = new THREE.Mesh(
          new THREE.BoxGeometry(2, 2, 0.1),
          windowMaterial
        );
        window2.position.set(-4, 4, -0.15);
        window2.castShadow = true;
        window2.receiveShadow = true;
        houseGroup.add(window2);

        // Muebles
        const table = new THREE.Mesh(
          new THREE.BoxGeometry(1.5, 1.2, 3),
          new THREE.MeshLambertMaterial({ color: 0x8b4513 })
        );
        table.position.set(3, 0.6, -4);
        table.castShadow = true;
        table.receiveShadow = true;
        houseGroup.add(table);

        const chair = new THREE.Mesh(
          new THREE.BoxGeometry(1.8, 1.2, 1.5),
          new THREE.MeshLambertMaterial({ color: 0x654321 })
        );
        chair.position.set(-3, 0.6, -8);
        chair.castShadow = true;
        chair.receiveShadow = true;
        houseGroup.add(chair);

        scene.add(houseGroup);
        house = houseGroup;
      }

      function createPlayer() {
        const playerGeometry = new THREE.BoxGeometry(0.5, 1.8, 0.5);
        const playerMaterial = new THREE.MeshLambertMaterial({
          color: 0xff6b6b,
        });
        player = new THREE.Mesh(playerGeometry, playerMaterial);
        player.position.set(position.x, position.y, position.z);
        player.visible = false; // Ocultar el mesh del jugador ya que usamos primera persona
        scene.add(player);
      }

      function createGround() {
        // Suelo exterior m√°s grande
        const groundGeometry = new THREE.PlaneGeometry(200, 200);
        const groundMaterial = new THREE.MeshLambertMaterial({
          color: 0x90ee90,
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -0.1;
        ground.receiveShadow = true;
        scene.add(ground);

        // Agregar algunas plantas decorativas
        for (let i = 0; i < 20; i++) {
          const treeGeometry = new THREE.ConeGeometry(0.5, 3, 8);
          const treeMaterial = new THREE.MeshLambertMaterial({
            color: 0x228b22,
          });
          const tree = new THREE.Mesh(treeGeometry, treeMaterial);
          tree.position.set(
            (Math.random() - 0.5) * 80,
            1.5,
            (Math.random() - 0.5) * 80 - 10
          );
          tree.castShadow = true;
          scene.add(tree);
        }
      }

      function setupControls() {
        document
          .getElementById("forwardBtn")
          .addEventListener("click", () => movePlayer("forward"));
        document
          .getElementById("backwardBtn")
          .addEventListener("click", () => movePlayer("backward"));
        document
          .getElementById("leftBtn")
          .addEventListener("click", () => movePlayer("left"));
        document
          .getElementById("rightBtn")
          .addEventListener("click", () => movePlayer("right"));
        document
          .getElementById("turnLeftBtn")
          .addEventListener("click", () => movePlayer("turnLeft"));
        document
          .getElementById("turnRightBtn")
          .addEventListener("click", () => movePlayer("turnRight"));
      }

      function setupVoiceRecognition() {
        const voiceButton = document.getElementById("voiceButton");
        const statusElement = document.getElementById("status");

        // Verificar compatibilidad
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          statusElement.innerHTML =
            '<span style="color: red;">‚ùå API de voz no disponible</span><br>Usa Chrome o Edge';
          voiceButton.disabled = true;
          return;
        }

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = "es-ES";

        recognition.onstart = function () {
          statusElement.innerHTML =
            '<span style="color: green;">üé§ Escuchando...</span><br>Habla ahora';
        };

        recognition.onresult = function (event) {
          const command = event.results[event.results.length - 1][0].transcript
            .toLowerCase()
            .trim();
          statusElement.innerHTML = `<span style="color: blue;">üîä Comando: "${command}"</span>`;

          // Mostrar comando por 2 segundos
          setTimeout(() => {
            statusElement.innerHTML =
              '<span style="color: green;">üé§ Escuchando...</span><br>Habla ahora';
          }, 2000);

          handleVoiceCommand(command);
        };

        recognition.onerror = function (event) {
          console.error("Error de reconocimiento:", event.error);
          statusElement.innerHTML = `<span style="color: red;">‚ùå Error: ${event.error}</span>`;
          isListening = false;
          voiceButton.textContent = "üé§ Iniciar Escucha";
          voiceButton.classList.remove("listening");
        };

        recognition.onend = function () {
          if (isListening) {
            try {
              recognition.start();
            } catch (e) {
              console.log("Reinicio autom√°tico fallido");
            }
          }
        };

        voiceButton.addEventListener("click", function () {
          if (isListening) {
            recognition.stop();
            isListening = false;
            voiceButton.textContent = "üé§ Iniciar Escucha";
            voiceButton.classList.remove("listening");
            statusElement.innerHTML = "Haz clic para comenzar";
          } else {
            try {
              recognition.start();
              isListening = true;
              voiceButton.textContent = "‚èπ Detener Escucha";
              voiceButton.classList.add("listening");
            } catch (error) {
              statusElement.innerHTML = `<span style="color: red;">‚ùå Error: ${error.message}</span>`;
            }
          }
        });
      }

      function handleVoiceCommand(command) {
        console.log("Comando recibido:", command);

        // Comandos m√°s flexibles
        const commands = {
          // Avanzar
          avanzar: "forward",
          adelante: "forward",
          "mover adelante": "forward",
          "ir adelante": "forward",
          "caminar adelante": "forward",

          // Retroceder
          retroceder: "backward",
          atr√°s: "backward",
          "mover atr√°s": "backward",
          "ir atr√°s": "backward",
          "caminar atr√°s": "backward",

          // Izquierda
          izquierda: "left",
          "mover izquierda": "left",
          "ir izquierda": "left",

          // Derecha
          derecha: "right",
          "mover derecha": "right",
          "ir derecha": "right",

          // Girar izquierda
          "girar izquierda": "turnLeft",
          "voltear izquierda": "turnLeft",
          "gira izquierda": "turnLeft",

          // Girar derecha
          "girar derecha": "turnRight",
          "voltear derecha": "turnRight",
          "gira derecha": "turnRight",
        };

        // Buscar comando coincidente
        let action = null;
        for (const [key, value] of Object.entries(commands)) {
          if (command.includes(key)) {
            action = value;
            break;
          }
        }

        if (action) {
          movePlayer(action);
          // Feedback visual
          document.getElementById(
            "status"
          ).innerHTML = `<span style="color: green;">‚úÖ Ejecutando: ${action}</span>`;
          setTimeout(() => {
            if (isListening) {
              document.getElementById("status").innerHTML =
                '<span style="color: green;">üé§ Escuchando...</span><br>Habla ahora';
            }
          }, 1000);
        } else {
          document.getElementById(
            "status"
          ).innerHTML = `<span style="color: orange;">‚ö† Comando no reconocido: "${command}"</span>`;
          setTimeout(() => {
            if (isListening) {
              document.getElementById("status").innerHTML =
                '<span style="color: green;">üé§ Escuchando...</span><br>Habla ahora';
            }
          }, 2000);
        }
      }

      function movePlayer(direction) {
        switch (direction) {
          case "forward":
            position.x += Math.sin(rotation.y) * moveSpeed;
            position.z += Math.cos(rotation.y) * moveSpeed;
            break;
          case "backward":
            position.x -= Math.sin(rotation.y) * moveSpeed;
            position.z -= Math.cos(rotation.y) * moveSpeed;
            break;
          case "left":
            position.x += Math.sin(rotation.y - Math.PI / 2) * moveSpeed;
            position.z += Math.cos(rotation.y - Math.PI / 2) * moveSpeed;
            break;
          case "right":
            position.x += Math.sin(rotation.y + Math.PI / 2) * moveSpeed;
            position.z += Math.cos(rotation.y + Math.PI / 2) * moveSpeed;
            break;
          case "turnLeft":
            rotation.y += turnSpeed;
            break;
          case "turnRight":
            rotation.y -= turnSpeed;
            break;
        }

        updateCamera();
        updatePositionInfo();
      }

      function updateCamera() {
        camera.position.set(position.x, 1.6, position.z);
        camera.rotation.set(rotation.x, rotation.y, rotation.z);
      }

      function updatePositionInfo() {
        document.getElementById("posX").textContent = position.x.toFixed(2);
        document.getElementById("posZ").textContent = position.z.toFixed(2);
        document.getElementById("rotY").textContent = Math.round(
          (rotation.y * 180) / Math.PI
        );
      }

      function onKeyDown(event) {
        switch (event.key.toLowerCase()) {
          case "w":
            movePlayer("forward");
            break;
          case "s":
            movePlayer("backward");
            break;
          case "a":
            movePlayer("left");
            break;
          case "d":
            movePlayer("right");
            break;
          case "q":
            movePlayer("turnLeft");
            break;
          case "e":
            movePlayer("turnRight");
            break;
          case "arrowup":
            movePlayer("forward");
            break;
          case "arrowdown":
            movePlayer("backward");
            break;
          case "arrowleft":
            movePlayer("turnLeft");
            break;
          case "arrowright":
            movePlayer("turnRight");
            break;
        }
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        requestAnimationFrame(animate);

        // Animaci√≥n suave de la c√°mara
        camera.position.set(position.x, 1.6, position.z);
        camera.rotation.set(rotation.x, rotation.y, rotation.z);

        renderer.render(scene, camera);
      }

      // Iniciar la aplicaci√≥n cuando la p√°gina cargue
      window.addEventListener("load", init);
    </script>
  </body>
</html>
